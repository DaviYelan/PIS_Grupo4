<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSS -->
    <link rel="stylesheet" href="{{url_for('static', filename='/staticEstudiante/css/style.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='/staticEstudiante/css/area.css')}}">
    <link rel="shortcut icon" href="{{url_for('static', filename='/staticEstudiante/img/SOL.png')}}" />
    <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css' rel='stylesheet'>    

    <title>SOL</title>

    <style>
        .menu-links .nav-link {
            position: relative;
        }

        .submenu {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .nav-link:hover>.submenu {
            display: block;
        }

        .submenu>li {
            position: relative;
        }

        .submenu>li:hover>.submenu {
            display: block;
        }

        .submenu a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .submenu a:hover {
            background-color: #f1f1f1;
        }

        .file-uploaded {
            background-color: #ffd700 !important;
            color: black !important;
        }

        .units-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .unit-section {
            width: auto;
            /* max-width: 800px; */
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;

        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .results-table th,
        .results-table td {
            padding: 12px 15px;
            border: 1px solid #ddd;
        }

        .results-table thead {
            background-color: #f2f2f2;
        }

        .results-table tbody tr:nth-child(even) {
            background-color: #f8f8f8;
        }

        .results-table tbody tr:hover {
            background-color: #e6e6e6;
        }

        .form-group button,
        #buttons-container button {
            padding: 10px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .form-group button:hover,
        #buttons-container button:hover {
            background-color: #45a049;
        }

        #buttons-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .action-button {
            padding: 10px;
            margin: 2px;
            background-color: #008cba;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .action-button:hover {
            background-color: #007b9a;
        }

        .category-a {
            background-color: #00bfff;
        }

        .category-b {
            background-color: #00ff00;
        }

        .category-c {
            background-color: #ffff00;
        }

        .category-d {
            background-color: #ff0000;
        }

        .matricula-1 {
            background-color: #00ff00;
        }

        .matricula-2 {
            background-color: #ffff00;
        }

        .matricula-3 {
            background-color: #ff0000;
        }

        .results-table td {
            padding: 12px 15px;
            /* text-align: left; */
            border: 1px solid #ddd;
        }

        .results-table .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .results-table .action-buttons button {
            padding: 10px;
            background-color: #008cba;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .results-table .action-buttons button:hover {
            background-color: #007b9a;
        }

        .button-container {
            margin-top: 20px;
        }

        #filter-form {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;


        }

        #filter-form label {
            font-weight: bold;

        }

        #filter-form select,
        #filter-form button {
            padding: 10px;
            font-size: 0.9em;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #filtered-results-container {
            margin-top: 20px;
        }

        #filtered-results-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #filtered-results-container th,
        #filtered-results-container td {
            padding: 12px 15px;
            border: 1px solid #ddd;
        }

        #filtered-results-container thead {
            background-color: #f2f2f2;
        }

        #filtered-results-container tbody tr:nth-child(even) {
            background-color: #f8f8f8;
        }

        #filtered-results-container tbody tr:hover {
            background-color: #e6e6e6;
        }

        .home {
            background-size: cover;
            /* Ajusta la imagen para que cubra todo el contenedor */
            background-position: center;
            /* Centra la imagen */
            background-repeat: no-repeat;
            /* Evita que la imagen se repita */
            padding: 35px;
            color: #000000;
            /* Cambia el color del texto para que contraste con la imagen */
        }
    </style>
</head>


<body>

    <nav class="sidebar close">
        <header>
            <div class="image-text">
                <span class="image">
                    <img src="{{url_for('static', filename='/staticEstudiante/img/SOL.png')}}" alt="">
                </span>

                <div class="text logo-text">
                    <span class="name">SOL</span>
                    <span class="profession">Docente</span>
                </div>
            </div>

            <i class='bx bx-chevron-right toggle'></i>
        </header>

        <div class="menu-bar">
            <div class="menu">
                <ul class="menu-links">
                    <li class="search-box">
                    </li>
                    <li class="nav-link">
                        <a href="#">
                            <i class='bx bxs-graduation icon'></i>
                            <span class="text nav-text">Area Principal</span>
                        </a>
                    </li>
                    <li class="nav-link">
                        <a href="/login/moduloDocentes/reportes">
                            <i class='bx bxs-graduation icon'></i>
                            <span class="text nav-text">Reportes</span>

                        </a>
                    </li>
                </ul>
            </div>

            <div class="bottom-content">
                <ul>
                    <li>
                        <a href="/logout">
                            <i class='bx bx-log-out icon'></i>
                            <span class="text nav-text">Cerrar Sesi√≥n</span>
                        </a>
                    </li>

                    <li class="mode">
                        <div class="sun-moon">
                            <i class='bx bx-moon icon moon'></i>
                            <i class='bx bx-sun icon sun'></i>
                        </div>
                        <span class="mode-text text">Dark mode</span>
                        <div class="toggle-switch">
                            <span class="switch"></span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="home">
        <div class="form-container">
            <form id="form-data">
                <div class="form-group">
                    <label for="cycle-select">Ciclo:</label>
                    <select id="ciclo" name="ciclo">
                        <option value="1">Ciclo 1</option>
                        <option value="2">Ciclo 2</option>
                        <option value="3">Ciclo 3</option>
                    </select>
                    <label for="materia">Materia:</label>
                    <select id="materia" name="materia">
                        <option value="1">Algebra Lineal</option>
                        <option value="2">Analisis Matematico</option>
                        <option value="3">Estructura de Datos</option>
                    </select>
                    <button type="submit">Seleccionar</button>
                </div>
            </form>
        </div>

        <div class="units-container">
            <div class="unit-section">
                <h2>Unidad 1</h2>
                <div class="form-group">
                    <button type="button" onclick="uploadExcel(1)" id="upload-button-1">Elegir Excel para Unidad
                        1</button>
                    <input type="file" id="file-upload-1" style="display:none" accept=".xlsx, .xls"
                        onchange="handleFileSelect(1)">
                </div>
                <div class="table-container" id="table-container-1">

                </div>
            </div>

            <div class="unit-section">
                <h2>Unidad 2</h2>
                <div class="form-group">
                    <button type="button" onclick="uploadExcel(2)" id="upload-button-2">Elegir Excel para Unidad
                        2</button>
                    <input type="file" id="file-upload-2" style="display:none" accept=".xlsx, .xls"
                        onchange="handleFileSelect(2)">
                </div>
                <div class="table-container" id="table-container-2">

                </div>
            </div>

            <div class="unit-section">
                <h2>Unidad 3</h2>
                <div class="form-group">
                    <button type="button" onclick="uploadExcel(3)" id="upload-button-3">Elegir Excel para Unidad
                        3</button>
                    <input type="file" id="file-upload-3" style="display:none" accept=".xlsx, .xls"
                        onchange="handleFileSelect(3)">
                </div>
                <div class="table-container" id="table-container-3">

                </div>
            </div>
        </div>

        <form id="filter-form">
            <label for="average-select">Categor√≠a:</label>
            <select id="average-select" name="average">
                <option value="">Todas</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
            </select>
            <label for="matricula-select">Matr√≠cula:</label>
            <select id="matricula-select" name="matricula">
                <option value="">Todas</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
            <button type="button" class="action-button filter-btn" onclick="applyFilter()">
                <i class="bx bx-filter-alt"></i> Filtrar
            </button>
            <!-- <button type="button" onclick="applyFilter()">Filtrar</button> -->
        </form>

        <div id="filtered-results-container" class="table-container"></div>

        <div id="buttons-container">
            <button onclick="downloadExcel()">Descargar Excel</button>
            <!-- <button onclick="downloadPDF()">Descargar PDF</button> -->
            <button onclick="sendReport('final')">Enviar reporte final</button>
        </div>

    </section>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
    <script src="{{url_for('static', filename='/staticEstudiante/js/area.js')}}"></script>
    <script src="{{url_for('static', filename='/staticEstudiante/js/script.js')}}"></script>

    <script>
        let unidadData = {};

        function downloadExcel() {
            const workbook = XLSX.utils.book_new();

            for (let unidad = 1; unidad <= 3; unidad++) {
                if (unidadData[`unidad${unidad}`]) {
                    const worksheet = XLSX.utils.json_to_sheet(unidadData[`unidad${unidad}`]);
                    XLSX.utils.book_append_sheet(workbook, worksheet, `Unidad ${unidad}`);
                }
            }

            const finalData = [];
            const students = {};

            for (let unidad = 1; unidad <= 3; unidad++) {
                if (unidadData[`unidad${unidad}`]) {
                    unidadData[`unidad${unidad}`].forEach(row => {
                        const key = `${row.Nombre} ${row.Apellido}`;

                        if (!students[key]) {
                            students[key] = {
                                Id: row.Id,
                                Nombre: row.Nombre,
                                Apellido: row.Apellido,
                                Matricula: row.Matricula,
                                promedios: [null, null, null],
                                comentarios: [null, null, null]
                            };
                        }

                        students[key].promedios[unidad - 1] = calcularPromedio(row);
                        students[key].comentarios[unidad - 1] = row.Comentario || '';
                    });
                }
            }

            for (const [key, info] of Object.entries(students)) {
                const promedioFinal = info.promedios.filter(p => p !== null).reduce((a, b) => a + b, 0) / info.promedios.filter(p => p !== null).length;
                const categoriaFinal = obtenerCategoria(promedioFinal);
                const necesitaSupletorio = info.promedios.some(promedio => promedio < 7) ? 'S√≠' : 'No';
                finalData.push({
                    'Id': info.Id,
                    'Nombre': info.Nombre,
                    'Apellido': info.Apellido,
                    'Matricula': info.Matricula,
                    'Promedio Unidad 1': info.promedios[0] !== null ? info.promedios[0].toFixed(2) : 'N/A',
                    'Promedio Unidad 2': info.promedios[1] !== null ? info.promedios[1].toFixed(2) : 'N/A',
                    'Promedio Unidad 3': info.promedios[2] !== null ? info.promedios[2].toFixed(2) : 'N/A',
                    'Promedio Final': promedioFinal.toFixed(2),
                    'Categor√≠a Final': categoriaFinal.text,
                    'Supletorio': necesitaSupletorio,
                });
            }

            const finalWorksheet = XLSX.utils.json_to_sheet(finalData);
            XLSX.utils.book_append_sheet(workbook, finalWorksheet, 'Resumen Final');

            XLSX.writeFile(workbook, 'Reporte_Estudiantes.xlsx');
        }

        function calcularPromedio(row) {
            const notas = Object.keys(row).filter(key => key.startsWith('Nota')).map(key => row[key]);
            const suma = notas.reduce((acc, nota) => acc + nota, 0);
            return suma / notas.length;
        }

        function obtenerCategoria(promedio) {
            if (promedio >= 8.5) return { text: 'A', color: 'category-a' };
            if (promedio >= 7.5) return { text: 'B', color: 'category-b' };
            if (promedio >= 5) return { text: 'C', color: 'category-c' };
            return { text: 'D', color: 'category-d' };
        }

        function uploadExcel(unidad) {
            document.getElementById(`file-upload-${unidad}`).click();
        }

        function handleFileSelect(unidad) {
            const fileInput = document.getElementById(`file-upload-${unidad}`);
            if (fileInput.files.length > 0) {
                updateExcelButton(unidad, true);
                handleFileUpload(unidad, fileInput.files[0]);
            }
        }

        function updateExcelButton(unidad, fileUploaded) {
            const button = document.getElementById(`upload-button-${unidad}`);
            if (fileUploaded) {
                button.textContent = `Actualizar Excel para Unidad ${unidad}`;
                button.classList.add('file-uploaded');
            } else {
                button.textContent = `Elegir Excel para Unidad ${unidad}`;
                button.classList.remove('file-uploaded');
            }
        }

        function handleFileUpload(unidad, file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                json.forEach(row => {
                    row.Promedio = calcularPromedio(row);
                    row.Categoria = obtenerCategoria(row.Promedio).text;
                    row.Comentario = row.Comentario || '';
                });

                unidadData[`unidad${unidad}`] = json;

                updateTable(unidad, json);

                if (Object.keys(unidadData).length === 3) {
                    createFinalTable();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function updateTable(unidad, data) {
            const tableContainer = document.getElementById(`table-container-${unidad}`);
            tableContainer.innerHTML = '';
            const table = document.createElement('table');
            table.classList.add('results-table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            const notasColumns = Object.keys(data[0]).filter(key => key.startsWith('Nota') && !isNaN(data[0][key]));

            thead.innerHTML = `
        <tr>
            <th>ID</th>
            <th>Matricula</th>
            <th>Nombre</th>
            <th>Apellido</th>
            ${notasColumns.map(col => `<th>${col}</th>`).join('')}
            <th>Promedio</th>
            <th>Categor√≠a</th>
            <th>Observaciones</th>
            <th>Acciones</th>
        </tr>
    `;

            data.forEach(row => {
                const matriculaClass = `matricula-${row.Matricula}`;
                const rowElement = document.createElement('tr');
                rowElement.innerHTML = `
            <td>${row.Id}</td>
            <td class="${matriculaClass}">${row.Matricula}</td>    
            <td>${row.Nombre}</td>
            <td>${row.Apellido}</td>
            ${notasColumns.map(col => `<td>${row[col]}</td>`).join('')}
            <td>${row.Promedio.toFixed(2)}</td>
            <td class="category-${row.Categoria.toLowerCase()}">${row.Categoria}</td>
            <td>${row.Comentario || ''}</td>
            <td class="action-buttons">
                <button class="action-button update-btn" onclick="updateStudent('${row.Id}')">
                    <i class="bx bx-edit"></i>
                </button>
                <button class="action-button delete-btn" onclick="deleteStudent('${row.Id}')">
                    <i class="bx bx-trash"></i>
                </button>
                <button onclick="addComment(${unidad}, '${row.Id}')">Observacion</button>
                <button onclick="getPrediction('${row.Id}')">Proyeccion</button>
            </td>
            </td>
        `;
                tbody.appendChild(rowElement);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            tableContainer.appendChild(table);

            const buttonContainer = document.createElement('div');
            buttonContainer.classList.add('button-container');
            buttonContainer.innerHTML = `
        <button class="action-button download-btn" onclick="downloadExcelUnit(${unidad})">
            <i class="bx bx-download"></i> Descargar Excel Unidad ${unidad}
        </button>
        <button class="action-button send-btn" onclick="sendReport(${unidad})">
            <i class="bx bx-send"></i> Enviar Datos Unidad ${unidad}
        </button>
    `;
            tableContainer.appendChild(buttonContainer);

            checkAllUnitsUploaded();
        }

        function checkAllUnitsUploaded() {
            if (Object.keys(unidadData).length === 3) {
                const finalButtonsContainer = document.getElementById('buttons-container');
                finalButtonsContainer.innerHTML = `
            <button class="action-button download-btn" onclick="downloadExcel()">
                <i class="bx bx-download"></i> Descargar Excel
            </button>
            <button class="action-button send-btn" onclick="sendReport('final')">
                <i class="bx bx-send"></i> Enviar reporte final
            </button>
        `;
                finalButtonsContainer.style.display = 'flex';
            }
        }

        function addComment(unidad, id) {
            Swal.fire({
                title: 'Ingrese el correo electr√≥nico y comentario para este estudiante:',
                html: `
            <input type="email" id="studentEmail" class="swal2-input" placeholder="Correo electr√≥nico">
            <textarea id="studentComment" class="swal2-textarea" placeholder="Comentario" aria-label="Escribe tu comentario aqu√≠"></textarea>
        `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Enviar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const email = Swal.getPopup().querySelector('#studentEmail').value;
                    const comment = Swal.getPopup().querySelector('#studentComment').value;
                    if (!email || !comment) {
                        Swal.showValidationMessage('¬°El correo electr√≥nico y el comentario no pueden estar vac√≠os!');
                    }
                    return { email: email, comment: comment };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { email, comment } = result.value;
                    // Guardar el comentario en la estructura de datos
                    if (!unidadData[`unidad${unidad}`]) {
                        unidadData[`unidad${unidad}`] = [];
                    }
                    const studentIndex = unidadData[`unidad${unidad}`].findIndex(s => s.Id.toString() === id);
                    if (studentIndex !== -1) {
                        unidadData[`unidad${unidad}`][studentIndex].Comentario = comment;
                        updateTable(unidad, unidadData[`unidad${unidad}`]);
                    }
                    // Enviar el correo electr√≥nico
                    sendEmail(email, comment);
                }
            });
        }

        function sendEmail(email, comment) {
            emailjs.send('your_service_id', 'your_template_id', {
                to_email: email,
                message: comment
            })
                .then((response) => {
                    console.log('Correo enviado exitosamente!', response.status, response.text);
                }, (error) => {
                    console.error('Error al enviar el correo:', error);
                });
        }



        function downloadExcelUnit(unidad) {
            const workbook = XLSX.utils.book_new();
            const data = unidadData[`unidad${unidad}`].map(row => {
                const newRow = {
                    Id: row.Id,
                    Matricula: row.Matricula,
                    Nombre: row.Nombre,
                    Apellido: row.Apellido,
                };
                Object.keys(row).filter(key => key.startsWith('Nota') && !isNaN(row[key])).forEach(key => {
                    newRow[key] = row[key];
                });
                newRow.Promedio = row.Promedio;
                newRow.Categoria = row.Categoria;
                return newRow;
            });
            const worksheet = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(workbook, worksheet, `Unidad ${unidad}`);
            XLSX.writeFile(workbook, `Reporte_Unidad_${unidad}.xlsx`);
        }

        function sendDataUnit(unidad) {
            console.log(`Enviando datos de Unidad ${unidad}:`, unidadData[`unidad${unidad}`]);
            alert(`Datos de Unidad ${unidad} enviados correctamente`);
        }

        function createFinalTable() {
            const finalTableContainer = document.createElement('div');
            finalTableContainer.id = 'final-table-container';
            finalTableContainer.innerHTML = '<h2>Tabla Final</h2>';

            const table = document.createElement('table');
            table.classList.add('results-table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            thead.innerHTML = `
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Matricula</th>
                    <th>Promedio Unidad 1</th>
                    <th>Promedio Unidad 2</th>
                    <th>Promedio Unidad 3</th>
                    <th>Promedio Final</th>
                    <th>Categor√≠a Final</th>
                    <th>Supletorio</th>
                </tr>
            `;

            const students = {};

            for (let unidad = 1; unidad <= 3; unidad++) {
                if (unidadData[`unidad${unidad}`]) {
                    unidadData[`unidad${unidad}`].forEach(row => {
                        const key = `${row.Nombre} ${row.Apellido}`;

                        if (!students[key]) {
                            students[key] = {
                                Id: row.Id,
                                Nombre: row.Nombre,
                                Apellido: row.Apellido,
                                Matricula: row.Matricula,
                                promedios: [null, null, null]
                            };
                        }

                        students[key].promedios[unidad - 1] = row.Promedio;
                    });
                }
            }

            Object.entries(students).forEach(([key, info]) => {
                const promedioFinal = info.promedios.filter(p => p !== null).reduce((a, b) => a + b, 0) / info.promedios.filter(p => p !== null).length;
                const categoriaFinal = obtenerCategoria(promedioFinal);
                const necesitaSupletorio = info.promedios.some(promedio => promedio < 7) ? 'S√≠' : 'No';

                const rowElement = document.createElement('tr');
                rowElement.innerHTML = `
                    <td>${info.Id}</td>
                    <td>${info.Nombre}</td>
                    <td>${info.Apellido}</td>
                    <td>${info.Matricula}</td>
                    <td>${info.promedios[0] !== null ? info.promedios[0].toFixed(2) : 'N/A'}</td>
                    <td>${info.promedios[1] !== null ? info.promedios[1].toFixed(2) : 'N/A'}</td>
                    <td>${info.promedios[2] !== null ? info.promedios[2].toFixed(2) : 'N/A'}</td>
                    <td>${promedioFinal.toFixed(2)}</td>
                    <td class="${categoriaFinal.color}">${categoriaFinal.text}</td>
                    <td   td>${necesitaSupletorio}</td>
                `;
                tbody.appendChild(rowElement);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            finalTableContainer.appendChild(table);

            document.querySelector('.units-container').appendChild(finalTableContainer);
        }

        function deleteStudent(id) {
            for (let unidad = 1; unidad <= 3; unidad++) {
                if (unidadData[`unidad${unidad}`]) {
                    unidadData[`unidad${unidad}`] = unidadData[`unidad${unidad}`].filter(student => student.Id.toString() !== id);
                    updateTable(unidad, unidadData[`unidad${unidad}`]);
                }
            }
            if (Object.keys(unidadData).length === 3) {
                createFinalTable();
            }
        }

        function applyFilter() {
            const category = document.getElementById('average-select').value;
            const matricula = document.getElementById('matricula-select').value;

            let filteredData = [];
            for (let unidad = 1; unidad <= 3; unidad++) {
                if (unidadData[`unidad${unidad}`]) {
                    const unitFilteredData = unidadData[`unidad${unidad}`].filter(student => {
                        return (!category || student.Categoria === category) &&
                            (!matricula || student.Matricula.toString() === matricula);
                    });
                    filteredData = filteredData.concat(unitFilteredData.map(student => ({ ...student, Unidad: unidad })));
                }
            }

            updateTableWithFilter(filteredData);
        }

        function updateTableWithFilter(data) {
            const tableContainer = document.getElementById('filtered-results-container');
            tableContainer.innerHTML = '';

            if (data.length === 0) {
                tableContainer.innerHTML = '<p>No se encontraron resultados.</p>';
                return;
            }

            const table = document.createElement('table');
            table.classList.add('results-table');

            const thead = document.createElement('thead');
            thead.innerHTML = `
        <tr>
            <th>Matricula</th>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Promedio</th>
            <th>Categor√≠a</th>
            <th>Unidad</th>
        </tr>
    `;

            const tbody = document.createElement('tbody');

            data.forEach(student => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${student.Matricula}</td>
            <td>${student.Nombre}</td>
            <td>${student.Apellido}</td>
            <td>${student.Promedio.toFixed(2)}</td>
            <td class="category-${student.Categoria.toLowerCase()}">${student.Categoria}</td>
            <td>Unidad ${student.Unidad}</td>
        `;
                tbody.appendChild(tr);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            tableContainer.appendChild(table);
        }

        function sendReport(type) {
            const cycleSelect = document.getElementById('cycle-select');
            const subjectSelect = document.getElementById('subject-select');

            let reportData;

            if (type === 'final') {
                reportData = {
                    type: type,
                    cycle: cycleSelect.value,
                    subject: subjectSelect.value,
                    data: unidadData
                };
            } else {
                const unitNumber = type;
                reportData = {
                    type: `unidad${unitNumber}`,
                    cycle: cycleSelect.value,
                    subject: subjectSelect.value,
                    data: unidadData[`unidad${unitNumber}`]
                };
            }

            fetch('/login/moduloDocentes/send_report', {
                method: 'POST',
                body: JSON.stringify(reportData),
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '√âxito',
                            text: 'Reporte enviado correctamente'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al enviar el reporte: ' + (data.message || 'Error desconocido')
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error al enviar el reporte'
                    });
                });
        }


        function getPrediction(id) {
            const studentUnidad1 = unidadData.unidad1 ? unidadData.unidad1.find(s => s.Id.toString() === id) : null;
            const studentUnidad2 = unidadData.unidad2 ? unidadData.unidad2.find(s => s.Id.toString() === id) : null;
            const studentUnidad3 = unidadData.unidad3 ? unidadData.unidad3.find(s => s.Id.toString() === id) : null;

            let mensaje = '';
            let notaNecesaria1 = 0;
            let notaNecesaria2 = 0;
            let icon = 'info';

            if (studentUnidad1 && studentUnidad2 && studentUnidad3) {
                const sumaTotal = studentUnidad1.Promedio + studentUnidad2.Promedio + studentUnidad3.Promedio;
                if (sumaTotal >= 21) {
                    mensaje = 'Aprobado';
                    icon = 'success';
                } else {
                    mensaje = 'Supletorio';
                    icon = 'error';
                }
            }
            else if (studentUnidad2 && studentUnidad3) {
                const sumaActual = studentUnidad2.Promedio + studentUnidad3.Promedio;
                notaNecesaria1 = 21 - sumaActual;
                if (notaNecesaria1 > 10) {
                    mensaje = 'Supletorio';
                    icon = 'error';
                } else {
                    mensaje = `Necesita sacar ${notaNecesaria1.toFixed(2)} en la Unidad 1 para aprobar`;
                    icon = 'info';
                }
            }
            else if (studentUnidad1 && studentUnidad3) {
                const sumaActual = studentUnidad1.Promedio + studentUnidad3.Promedio;
                notaNecesaria1 = 21 - sumaActual;
                if (notaNecesaria1 > 10) {
                    mensaje = 'Supletorio';
                    icon = 'error';
                } else {
                    mensaje = `Necesita sacar ${notaNecesaria1.toFixed(2)} en la Unidad 2 para aprobar`;
                    icon = 'info';
                }
            }
            else if (studentUnidad1 && studentUnidad2) {
                const sumaActual = studentUnidad1.Promedio + studentUnidad2.Promedio;
                notaNecesaria1 = 21 - sumaActual;
                if (notaNecesaria1 > 10) {
                    mensaje = 'Supletorio';
                    icon = 'error';
                } else {
                    mensaje = `Necesita sacar ${notaNecesaria1.toFixed(2)} en la Unidad 3 para aprobar`;
                    icon = 'info';
                }
            }
            else if (studentUnidad3) {
                notaNecesaria1 = (21 - studentUnidad3.Promedio) / 2;
                notaNecesaria2 = notaNecesaria1;
                if (notaNecesaria1 > 10) {
                    mensaje = 'Supletorio';
                    icon = 'error';
                } else {
                    mensaje = `Necesita sacar ${notaNecesaria1.toFixed(2)} en la Unidad 1 y ${notaNecesaria2.toFixed(2)} en la Unidad 2 para aprobar`;
                    icon = 'info';
                }
            }
            else if (studentUnidad2) {
                notaNecesaria1 = (21 - studentUnidad2.Promedio) / 2;
                notaNecesaria2 = notaNecesaria1;
                if (notaNecesaria1 > 10) {
                    mensaje = 'Supletorio';
                    icon = 'error';
                } else {
                    mensaje = `Necesita sacar ${notaNecesaria1.toFixed(2)} en la Unidad 1 y ${notaNecesaria2.toFixed(2)} en la Unidad 3 para aprobar`;
                    icon = 'info';
                }
            }
            else if (studentUnidad1) {
                notaNecesaria1 = (21 - studentUnidad1.Promedio) / 2;
                notaNecesaria2 = notaNecesaria1;
                if (notaNecesaria1 > 10) {
                    mensaje = 'Supletorio';
                    icon = 'error';
                } else {
                    mensaje = `Necesita sacar ${notaNecesaria1.toFixed(2)} en la Unidad 2 y ${notaNecesaria2.toFixed(2)} en la Unidad 3 para aprobar`;
                    icon = 'info';
                }
            }
            else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Se necesitan datos de al menos una unidad adicional (Unidad 2 o Unidad 3)'
                });
                return;
            }

            Swal.fire({
                icon: icon,
                title: 'Proyecci√≥n',
                text: mensaje
            });
        }

        function downloadReport(reportId) {
            window.location.href = `/download_report/${reportId}`;
        }

        function viewReport(reportId) {
            window.open(`/view_report/${reportId}`, '_blank');
        }

        function updateStudent(matricula) {
            alert(`actualizan el estudiante por medio de su id ${matricula}`);
        }

    </script>

    <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script type="text/javascript">
        (function () {
            emailjs.init("your_user_id");
        })();
    </script>
</body>

</html>